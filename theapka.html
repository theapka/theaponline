<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កែសម្រួលធៀប - ធៀប អនឡាញ</title> <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://npmcdn.com/flatpickr/dist/l10n/kh.js"></script> 

    <style>
        /* ... (CSS ទាំងអស់នៅដដែល) ... */
        body { font-family: 'Kantumruy Pro', sans-serif; }
        body, header, main, footer { transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out; }
        .upload-container { position: relative; }
        .upload-box { position: relative; cursor: pointer; }
        .upload-box img { width: 100%; height: 100%; object-fit: cover; border-radius: 0.5rem; }
        .upload-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.4); color: white; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; border-radius: 0.5rem; }
        .upload-box:hover .upload-overlay { opacity: 1; }
        .delete-image-btn { position: absolute; top: 8px; right: 8px; background-color: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 2px solid white; }
        .flatpickr-calendar { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .dark .flatpickr-calendar { background: #1f2937; border-color: #4b5563; }
        .dark .flatpickr-weekday, .dark .flatpickr-day, .dark .flatpickr-current-month, .dark .numInput { color: #d1d5db; }
        .dark .flatpickr-day:hover, .dark .flatpickr-day.flatpickr-disabled:hover { background: #374151; }
        .flatpickr-day.selected { background: #ec4899; border-color: #ec4899; }
        .preview-data { word-break: break-word; }
    </style>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex flex-col min-h-screen">

    <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-pink-500" data-lang-key="nav_brand">ធៀប អនឡាញ</a>
            <div class="flex items-center space-x-4">
                <button id="lang-toggle" class="text-gray-600 dark:text-gray-300 hover:text-pink-500">
                    <i class="fas fa-globe"></i> <span id="lang-text">EN</span>
                </button>
                <div id="user-profile-container" class="relative hidden">
                    <button id="profile-button" class="flex items-center space-x-2 focus:outline-none">
                        <img id="profile-avatar" src="https://placehold.co/32x32/cccccc/FFFFFF?text=U" alt="User Profile" class="w-8 h-8 rounded-full object-cover bg-gray-200">
                    </button>
                    <div id="profile-dropdown" class="absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 hidden">
                        <div class="px-4 py-3">
                            <p class="text-sm font-semibold text-gray-900 dark:text-white" id="profile-display-name">User Name</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400 truncate" id="profile-email">user@example.com</p>
                        </div>
                        <div class="border-t border-gray-200 dark:border-gray-600"></div>
                        <a href="index.html" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-lang-key="home_link">
                             <i class="fas fa-home fa-fw mr-2 text-gray-400"></i>
                             <span data-lang-key="home_link">ទំព័រដើម</span>
                        </a>
                        <a href="theap1.html" class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-lang-key="dashboard_link">
                             <i class="fas fa-chart-pie fa-fw mr-2 text-gray-400"></i>
                             <span data-lang-key="dashboard_link">ផ្ទាំងគ្រប់គ្រង</span>
                        </a>
                        <div class="border-t border-gray-200 dark:border-gray-600"></div>
                        <button id="theme-toggle" class="w-full text-left flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <div class="w-5 mr-2 flex items-center justify-center">
                               <i class="fas fa-sun text-gray-400" id="sun-icon"></i>
                               <i class="fas fa-moon text-gray-400 hidden" id="moon-icon"></i>
                            </div>
                            <span data-lang-key="theme_label_light">ប្តូរទៅពេលយប់</span>
                        </button>
                        <div class="border-t border-gray-200 dark:border-gray-600"></div>
                        <button id="logout-btn" class="w-full text-left flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-lang-key="logout_btn">
                            <i class="fas fa-sign-out-alt fa-fw mr-2 text-gray-400"></i>
                            <span data-lang-key="logout_btn">ចាកចេញ</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 flex-grow">
        <div id="loader" class="text-center p-10">
            <i class="fas fa-spinner fa-spin text-4xl text-pink-500"></i>
        </div>
        <div id="form-content" class="max-w-4xl mx-auto bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg hidden">
            <h1 class="text-2xl font-bold text-center text-gray-800 dark:text-white mb-8" data-lang-key="form_title">បង្កើតព័ត៌មានធៀប</h1>
            <form id="wedding-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="groom-name" class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            <i class="fas fa-user w-5 mr-2 text-gray-400"></i>
                            <span data-lang-key="groom_name_label">ឈ្មោះកូនកំលោះ</span>
                        </label>
                        <input type="text" name="groom-name" id="groom-name" class="block w-full rounded-md border-gray-200 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 focus:border-pink-500 focus:ring-pink-500 sm:text-sm py-2.5 px-4">
                    </div>
                    <div>
                        <label for="bride-name" class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                             <i class="fas fa-user w-5 mr-2 text-gray-400"></i>
                            <span data-lang-key="bride_name_label">ឈ្មោះកូនក្រមុំ</span>
                        </label>
                        <input type="text" name="bride-name" id="bride-name" class="block w-full rounded-md border-gray-200 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 focus:border-pink-500 focus:ring-pink-500 sm:text-sm py-2.5 px-4">
                    </div>
                </div>
    
                <div>
                     <label for="wedding-date" class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        <i class="fas fa-calendar-alt w-5 mr-2 text-gray-400"></i>
                        <span data-lang-key="date_label">ថ្ងៃ​ ខែ ឆ្នាំ</span>
                    </label>
                    <input type="text" name="wedding-date" id="wedding-date" placeholder="សូមជ្រើសរើសថ្ងៃខែ និងពេលវេលា" class="block w-full rounded-md border-gray-200 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 focus:border-pink-500 focus:ring-pink-500 sm:text-sm py-2.5 px-4 cursor-pointer">
                </div>
    
                <div>
                    <label for="location" class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        <i class="fas fa-map-marker-alt w-5 mr-2 text-gray-400"></i>
                        <span data-lang-key="location_label">ទីតាំងពិធី</span>
                    </label>
                    <input type="text" name="location" id="location" class="block w-full rounded-md border-gray-200 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 focus:border-pink-500 focus:ring-pink-500 sm:text-sm py-2.5 px-4" placeholder="*(ឧ. ភោជនីយដ្ឋាន)">
                     <input type="text" name="location-detail" id="location-detail" class="mt-2 block w-full rounded-md border-gray-200 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 focus:border-pink-500 focus:ring-pink-500 sm:text-sm py-2.5 px-4" placeholder="ទីតាំងពិធីលើ Google Map">
                </div>
                
                <div>
                    <label for="map-link" class="flex items-center text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        <i class="fas fa-link w-5 mr-2 text-gray-400"></i>
                        <span data-lang-key="map_link_label">Google Map</span>
                    </label>
                    <input type="url" name="map-link" id="map-link" class="block w-full rounded-md border-gray-200 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 focus:border-pink-500 focus:ring-pink-500 sm:text-sm py-2.5 px-4" placeholder="*(តំណភ្ជាប់ទៅកាន់ទីតាំងពិធី)">
                </div>
    
                <div class="!mt-8 border-t border-gray-200 dark:border-gray-700 pt-6">
                   <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="text-center upload-container">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" data-lang-key="couple_photo_label">រូបភាពកូនកំលោះ-កូនក្រមុំ</label>
                            <div id="couple-photo-upload" class="upload-box flex justify-center items-center w-full h-52 bg-gray-50 dark:bg-gray-700/50 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <img id="couple-photo-preview" src="" alt="Couple Preview" class="hidden">
                                <div id="couple-photo-placeholder" class="text-center p-4">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                                    <p class="text-sm text-pink-500"><span data-lang-key="upload_click">ចុចដើម្បីផ្ទុកឡើង</span></p>
                                </div>
                                <div class="upload-overlay"><i class="fas fa-edit text-2xl"></i></div>
                            </div>
                            <button type="button" id="couple-photo-delete" class="delete-image-btn hidden"><i class="fas fa-times"></i></button>
                            <input type="file" id="couple-photo-input" class="hidden" accept="image/*">
                        </div>
                        <div class="text-center upload-container">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" data-lang-key="groom_qr_label">KHQR ប្រាក់កូនកំលោះ</label>
                            <div id="groom-qr-upload" class="upload-box flex justify-center items-center w-full h-52 bg-gray-50 dark:bg-gray-700/50 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <img id="groom-qr-preview" src="" alt="Groom QR Preview" class="hidden">
                                <div id="groom-qr-placeholder" class="text-center p-4">
                                    <i class="fas fa-qrcode text-4xl text-gray-400 mb-3"></i>
                                    <p class="text-sm text-pink-500"><span data-lang-key="upload_click">ចុចដើម្បីផ្ទុកឡើង</span></p>
                                </div>
                                <div class="upload-overlay"><i class="fas fa-edit text-2xl"></i></div>
                            </div>
                            <button type="button" id="groom-qr-delete" class="delete-image-btn hidden"><i class="fas fa-times"></i></button>
                            <input type="file" id="groom-qr-input" class="hidden" accept="image/*">
                        </div>
                         <div class="text-center upload-container">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" data-lang-key="bride_qr_label">KHQR ប្រាក់កូនក្រមុំ</label>
                            <div id="bride-qr-upload" class="upload-box flex justify-center items-center w-full h-52 bg-gray-50 dark:bg-gray-700/50 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <img id="bride-qr-preview" src="" alt="Bride QR Preview" class="hidden">
                                <div id="bride-qr-placeholder" class="text-center p-4">
                                    <i class="fas fa-qrcode text-4xl text-gray-400 mb-3"></i>
                                    <p class="text-sm text-pink-500"><span data-lang-key="upload_click">ចុចដើម្បីផ្ទុកឡើង</span></p>
                                </div>
                                <div class="upload-overlay"><i class="fas fa-edit text-2xl"></i></div>
                            </div>
                            <button type="button" id="bride-qr-delete" class="delete-image-btn hidden"><i class="fas fa-times"></i></button>
                            <input type="file" id="bride-qr-input" class="hidden" accept="image/*">
                        </div>
                    </div>
                </div>
                
                <div class="!mt-10 flex justify-center">
                     <button type="submit" id="preview-button" class="w-full sm:w-auto bg-pink-600 text-white px-20 py-3.5 rounded-full font-bold text-lg hover:bg-pink-700 focus:outline-none focus:ring-4 focus:ring-pink-300 dark:focus:ring-pink-800 transition duration-300 shadow-lg hover:shadow-xl flex items-center justify-center">
                        <span data-lang-key="preview_button">ត្រួតពិនិត្យ</span>
                    </button>
                </div>
            </form>
        </div>

        <div id="preview-content" class="max-w-4xl mx-auto hidden">
            <div class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg">
                <h1 class="text-2xl font-bold text-center text-gray-800 dark:text-white mb-8" data-lang-key="preview_title">ពិនិត្យព័ត៌មានឡើងវិញ</h1>
                
                <div class="space-y-4 text-gray-700 dark:text-gray-300">
                    <div class="flex flex-col sm:flex-row"><p class="w-full sm:w-1/3 font-semibold" data-lang-key="groom_name_label">ឈ្មោះកូនកំលោះ</p><p id="preview-groom-name" class="w-full sm:w-2/3 preview-data"></p></div>
                    <div class="flex flex-col sm:flex-row"><p class="w-full sm:w-1/3 font-semibold" data-lang-key="bride_name_label">ឈ្មោះកូនក្រមុំ</p><p id="preview-bride-name" class="w-full sm:w-2/3 preview-data"></p></div>
                    <div class="flex flex-col sm:flex-row"><p class="w-full sm:w-1/3 font-semibold" data-lang-key="date_label">ថ្ងៃ​ ខែ ឆ្នាំ</p><p id="preview-wedding-date" class="w-full sm:w-2/3 preview-data"></p></div>
                    <div class="flex flex-col sm:flex-row"><p class="w-full sm:w-1/3 font-semibold" data-lang-key="location_label">ទីតាំងពិធី</p><p id="preview-location" class="w-full sm:w-2/3 preview-data"></p></div>
                    <div class="flex flex-col sm:flex-row"><p class="w-full sm:w-1/3 font-semibold" data-lang-key="location_detail_label">ទីតាំងលម្អិត</p><p id="preview-location-detail" class="w-full sm:w-2/3 preview-data"></p></div>
                    <div class="flex flex-col sm:flex-row"><p class="w-full sm:w-1/3 font-semibold" data-lang-key="map_link_label">Google Map</p><p id="preview-map-link" class="w-full sm:w-2/3 preview-data"></p></div>
                </div>

                <div class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-6">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                        <div class="text-center"><p class="font-semibold mb-2" data-lang-key="couple_photo_label">រូបភាព</p><img id="preview-couple-photo" src="https://placehold.co/400x400/e2e8f0/94a3b8?text=No+Image" class="w-full h-auto max-h-52 object-contain rounded-lg bg-gray-100 dark:bg-gray-700"></div>
                        <div class="text-center"><p class="font-semibold mb-2" data-lang-key="groom_qr_label">KHQR កូនកំលោះ</p><img id="preview-groom-qr" src="https://placehold.co/400x400/e2e8f0/94a3b8?text=No+Image" class="w-full h-auto max-h-52 object-contain rounded-lg bg-gray-100 dark:bg-gray-700"></div>
                        <div class="text-center"><p class="font-semibold mb-2" data-lang-key="bride_qr_label">KHQR កូនក្រមុំ</p><img id="preview-bride-qr" src="https://placehold.co/400x400/e2e8f0/94a3b8?text=No+Image" class="w-full h-auto max-h-52 object-contain rounded-lg bg-gray-100 dark:bg-gray-700"></div>
                    </div>
                </div>

                <div class="!mt-10 flex flex-col sm:flex-row justify-center gap-4">
                    <button type="button" id="edit-button" class="w-full sm:w-auto bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-12 py-3.5 rounded-full font-bold text-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition"><i class="fas fa-pencil-alt mr-2"></i><span data-lang-key="edit_button">កែសម្រួល</span></button>
                    <button type="button" id="save-button" class="w-full sm:w-auto bg-pink-600 text-white px-12 py-3.5 rounded-full font-bold text-lg hover:bg-pink-700 transition shadow-lg hover:shadow-xl flex items-center justify-center disabled:opacity-50">
                        <span id="save-button-text" data-lang-key="save_button">បញ្ជាក់ & រក្សាទុក</span>
                        <i id="save-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="bg-white dark:bg-gray-800 py-12 border-t dark:border-gray-700">
         <div class="container mx-auto px-6 text-center text-gray-600 dark:text-gray-400">
            <p data-lang-key="footer_text">&copy; 2025 ធៀប អនឡាញ. រក្សាសិទ្ធិគ្រប់យ៉ាង។</p>
         </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Config (from user's file) ---
        const firebaseConfig = {
          apiKey: "AIzaSyBuE7NiFGrSg8FdKq-E_I0ygle3HetUhsw",
          authDomain: "theap-online-website.firebaseapp.com",
          projectId: "theap-online-website",
          storageBucket: "theap-online-website.appspot.com",
          messagingSenderId: "460601895037",
          appId: "1:460601895037:web:e40ea194c9d801934e2914"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Cloudinary Config (from user's file) ---
        const CLOUDINARY_CLOUD_NAME = "ddalvint2";
        const CLOUDINARY_UPLOAD_PRESET = "theap_online_preset";
        
        // --- បន្ថែម៖ Translation Object ---
        const translations = {
            km: {
                page_title: 'កែសម្រួលធៀប - ធៀប អនឡាញ',
                nav_brand: 'ធៀប អនឡាញ', home_link: 'ទំព័រដើម', logout_btn: 'ចាកចេញ', footer_text: '&copy; 2025 ធៀប អនឡាញ. រក្សាសិទ្ធិគ្រប់យ៉ាង។',
                form_title: 'បង្កើត ឬ កែសម្រួលព័ត៌មានធៀប',
                groom_name_label: 'ឈ្មោះកូនកំលោះ', bride_name_label: 'ឈ្មោះកូនក្រមុំ', date_label: 'ថ្ងៃ​ ខែ ឆ្នាំ', location_label: 'ទីតាំងពិធី', location_detail_label: 'ទីតាំងលម្អិត', map_link_label: 'Google Map', couple_photo_label: 'រូបភាព', groom_qr_label: 'KHQR កូនកំលោះ', bride_qr_label: 'KHQR កូនក្រមុំ', upload_click: 'ចុចដើម្បីផ្ទុកឡើង', 
                preview_button: 'ត្រួតពិនិត្យ', save_button: 'បញ្ជាក់ & រក្សាទុក', preview_title: 'ពិនិត្យព័ត៌មានឡើងវិញ', edit_button: 'កែសម្រួល',
                theme_label_light: 'ប្តូរទៅពេលយប់',
                theme_label_dark: 'ប្តូរទៅពេលថ្ងៃ',
                dashboard_link: 'ផ្ទាំងគ្រប់គ្រង', 
            },
            en: {
                page_title: 'Edit Card - Theap Online',
                nav_brand: 'Theap Online', home_link: 'Home Page', logout_btn: 'Logout', footer_text: '&copy; 2025 Theap Online. All rights reserved.',
                form_title: 'Create or Edit Invitation Details',
                groom_name_label: "Groom's Name", bride_name_label: "Bride's Name", date_label: 'Date & Time', location_label: 'Venue Location', location_detail_label: 'Location Detail', map_link_label: 'Google Map Link', couple_photo_label: 'Couple Photo', groom_qr_label: "Groom's KHQR", bride_qr_label: "Bride's KHQR", upload_click: 'Click to upload', 
                preview_button: 'Preview', save_button: 'Confirm & Save', preview_title: 'Review Information', edit_button: 'Go Back & Edit',
                theme_label_light: 'Switch to Night',
                theme_label_dark: 'Switch to Day',
                dashboard_link: 'Dashboard', 
            }
        };

        const themeToggleButton = document.getElementById('theme-toggle');
        const langToggleButton = document.getElementById('lang-toggle'); // បន្ថែម
        const logoutBtn = document.getElementById('logout-btn');
        const profileButton = document.getElementById('profile-button');
        const profileDropdown = document.getElementById('profile-dropdown');
        const weddingForm = document.getElementById('wedding-form');
        const saveButton = document.getElementById('save-button');
        const editButton = document.getElementById('edit-button');
        const formContent = document.getElementById('form-content');
        const previewContent = document.getElementById('preview-content');

        let currentUser = null;
        let datePicker;
        let currentLang = localStorage.getItem('lang') || 'km'; // បន្ថែម

        function initializeDatePicker(lang) {
            if (datePicker) datePicker.destroy();
            // ធានាថាប្រើ 'kh' សម្រាប់ប្រតិទិនខ្មែរ
            datePicker = flatpickr("#wedding-date", {
                enableTime: true, dateFormat: "Y-m-d H:i", altInput: true,
                altFormat: "j F Y, h:i K", locale: lang === 'km' ? 'kh' : 'default'
            });
        }

        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            document.getElementById('sun-icon').classList.toggle('hidden', theme === 'dark');
            document.getElementById('moon-icon').classList.toggle('hidden', theme !== 'dark');
            
            const themeButtonText = document.querySelector('#theme-toggle span[data-lang-key]');
            if (themeButtonText) {
                const lang = currentLang || 'km';
                if (theme === 'dark') {
                    themeButtonText.innerHTML = translations[lang].theme_label_dark || 'Switch to Day';
                    themeButtonText.dataset.langKey = 'theme_label_dark';
                } else {
                    themeButtonText.innerHTML = translations[lang].theme_label_light || 'Switch to Night';
                    themeButtonText.dataset.langKey = 'theme_label_light';
                }
            }
        }

        // បន្ថែម៖ Function ប្តូរភាសា
        function changeLanguage(lang) {
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                const target = (el.querySelector('span') && el.dataset.langKey === key) ? el.querySelector('span') : el;
                
                if (translations[lang]?.[key]) {
                    if (el.dataset.langKey === key) {
                         target.innerHTML = translations[lang][key];
                    }
                }
            });
            document.title = translations[lang].page_title;
            document.documentElement.lang = lang;
            document.getElementById('lang-text').innerText = lang === 'km' ? 'EN' : 'ខ្មែរ';
            initializeDatePicker(lang);
            applyTheme(document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }

        // បន្ថែម៖ Event Listener សម្រាប់ប៊ូតុងភាសា
        langToggleButton.addEventListener('click', () => {
            currentLang = currentLang === 'km' ? 'en' : 'km';
            localStorage.setItem('lang', currentLang);
            changeLanguage(currentLang);
        });

        themeToggleButton.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            applyTheme(isDark ? 'dark' : 'light');
        });

        logoutBtn.addEventListener('click', () => signOut(auth));
        profileButton.addEventListener('click', e => {
            e.stopPropagation();
            profileDropdown.classList.toggle('hidden');
        });
        document.addEventListener('click', () => profileDropdown.classList.add('hidden'));
        
        // --- File Upload Logic (from user's file) ---
        function setupUpload(inputId, triggerId, previewId, placeholderId, deleteBtnId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const placeholder = document.getElementById(placeholderId);
            const deleteBtn = document.getElementById(deleteBtnId);

            document.getElementById(triggerId).addEventListener('click', () => input.click());

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        preview.src = event.target.result;
                        preview.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                        deleteBtn.classList.remove('hidden');
                        preview.dataset.isNew = "true";
                    }
                    reader.readAsDataURL(file);
                }
            });

            deleteBtn.addEventListener('click', () => {
                input.value = '';
                preview.src = '';
                preview.classList.add('hidden');
                placeholder.classList.remove('hidden');
                deleteBtn.classList.add('hidden');
                preview.dataset.isNew = "false";
                if (preview.dataset.savedUrl) {
                    preview.dataset.deleted = "true";
                }
            });
        }

        async function loadWeddingData(userId) {
            const docRef = doc(db, "weddingInvitations", userId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('groom-name').value = data.groomName || '';
                    document.getElementById('bride-name').value = data.brideName || '';
                    if (data.weddingDate) datePicker.setDate(data.weddingDate, true);
                    document.getElementById('location').value = data.location || '';
                    document.getElementById('location-detail').value = data.locationDetail || '';
                    document.getElementById('map-link').value = data.mapLink || '';

                    const loadUrl = (url, previewId, placeholderId, deleteBtnId) => {
                         if (url) {
                            const preview = document.getElementById(previewId);
                            preview.src = url;
                            preview.dataset.savedUrl = url;
                            preview.dataset.isNew = "false";
                            preview.dataset.deleted = "false";
                            preview.classList.remove('hidden');
                            document.getElementById(placeholderId).classList.add('hidden');
                            document.getElementById(deleteBtnId).classList.remove('hidden');
                        }
                    };
                    loadUrl(data.couplePhotoUrl, 'couple-photo-preview', 'couple-photo-placeholder', 'couple-photo-delete');
                    loadUrl(data.groomQrUrl, 'groom-qr-preview', 'groom-qr-placeholder', 'groom-qr-delete');
                    loadUrl(data.brideQrUrl, 'bride-qr-preview', 'bride-qr-placeholder', 'bride-qr-delete');
                }
            } catch (error) { console.error("Error loading wedding data:", error); }
        }

        // --- Cloudinary Upload Function (from user's file) ---
        async function handleFileUpload(inputId, previewId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const file = input.files[0];

            if (file && preview.dataset.isNew === "true") {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                if (CLOUDINARY_CLOUD_NAME === "YOUR_CLOUD_NAME_HERE") {
                    alert("Config error: Cloudinary name is missing.");
                    throw new Error("Cloudinary config missing");
                }

                try {
                    const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        console.error('Cloudinary upload failed:', await response.json());
                        throw new Error('Cloudinary upload failed');
                    }
                    
                    const data = await response.json();
                    return data.secure_url; 
                    
                } catch (err) {
                    console.error("Cloudinary upload error:", err);
                    throw err;
                }
            }

            if (preview.dataset.deleted === "true" && preview.dataset.savedUrl) {
                return null;
            }

            if (!file && preview.dataset.savedUrl && preview.dataset.deleted !== "true") {
                return preview.dataset.savedUrl;
            }

            return null;
        }


        // --- FORM & PREVIEW LOGIC (from user's file) ---
        weddingForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const getPreviewText = id => document.getElementById(id).value || 'N/A';
            const getPreviewImage = (previewId) => {
                const src = document.getElementById(previewId).src;
                return src && !src.endsWith('/') ? src : "https://placehold.co/400x400/e2e8f0/94a3b8?text=No+Image";
            };

            document.getElementById('preview-groom-name').textContent = getPreviewText('groom-name');
            document.getElementById('preview-bride-name').textContent = getPreviewText('bride-name');
            document.getElementById('preview-wedding-date').textContent = datePicker.altInput.value || 'N/A';
            document.getElementById('preview-location').textContent = getPreviewText('location');
            document.getElementById('preview-location-detail').textContent = getPreviewText('location-detail');
            document.getElementById('preview-map-link').textContent = getPreviewText('map-link');
            document.getElementById('preview-couple-photo').src = getPreviewImage('couple-photo-preview');
            document.getElementById('preview-groom-qr').src = getPreviewImage('groom-qr-preview');
            document.getElementById('preview-bride-qr').src = getPreviewImage('bride-qr-preview');

            formContent.classList.add('hidden');
            previewContent.classList.remove('hidden');
            window.scrollTo(0, 0);
        });
        
        editButton.addEventListener('click', () => {
            previewContent.classList.add('hidden');
            formContent.classList.remove('hidden');
        });

        // --- កែប្រែ៖ ប្តូរ Save Logic ---
        saveButton.addEventListener('click', async () => {
            if (!currentUser) return;
            
            saveButton.disabled = true;
            const spinner = document.getElementById('save-spinner');
            spinner.classList.remove('hidden');

            try {
                const [couplePhotoUrl, groomQrUrl, brideQrUrl] = await Promise.all([
                    handleFileUpload('couple-photo-input', 'couple-photo-preview'),
                    handleFileUpload('groom-qr-input', 'groom-qr-preview'),
                    handleFileUpload('bride-qr-input', 'bride-qr-preview')
                ]);
                
                const dataToSave = {
                    groomName: document.getElementById('groom-name').value, 
                    brideName: document.getElementById('bride-name').value,
                    weddingDate: document.getElementById('wedding-date').value, 
                    location: document.getElementById('location').value,
                    locationDetail: document.getElementById('location-detail').value, 
                    mapLink: document.getElementById('map-link').value,
                    couplePhotoUrl, groomQrUrl, brideQrUrl, 
                    updatedAt: new Date().toISOString()
                };

                await setDoc(doc(db, "weddingInvitations", currentUser.uid), dataToSave, { merge: true });

                // --- ប្តូរ Redirect ទៅ 'my-cards.html' ---
                window.location.href = 'my-cards.html';
                
            } catch (error) {
                console.error("Error saving data: ", error);
                if (error.message !== "Cloudinary config missing") {
                    alert("An error occurred. Please try again.");
                }
                saveButton.disabled = false;
                spinner.classList.add('hidden');
            } 
        });
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loader').classList.add('hidden');
                formContent.classList.remove('hidden');
                const profileContainer = document.getElementById('user-profile-container');
                profileContainer.classList.remove('hidden');

                const displayName = user.displayName || user.email.split('@')[0];
                document.getElementById('profile-email').textContent = user.email;
                document.getElementById('profile-display-name').textContent = displayName;
                document.getElementById('profile-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=f472b6&color=fff`;
                
                await loadWeddingData(user.uid);
            } else {
                window.location.href = 'index.html';
            }
        });

        // --- INITIALIZATION ---
        setupUpload('couple-photo-input', 'couple-photo-upload', 'couple-photo-preview', 'couple-photo-placeholder', 'couple-photo-delete');
        setupUpload('groom-qr-input', 'groom-qr-upload', 'groom-qr-preview', 'groom-qr-placeholder', 'groom-qr-delete');
        setupUpload('bride-qr-input', 'bride-qr-upload', 'bride-qr-preview', 'bride-qr-placeholder', 'bride-qr-delete');
        
        const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(currentTheme);
        // ហៅ changeLanguage ពេលចាប់ផ្តើម
        changeLanguage(currentLang);
    </script>
</body>
</html>